# æŒ‡æ ‡ç®—æ³•ä¼˜åŒ–æ–‡æ¡£ (P0 + P1 + P2)

**ç‰ˆæœ¬**: 3.0
**æ—¥æœŸ**: 2026-02-03
**çŠ¶æ€**: âœ… P0 + P1 + P2 å®Œæˆ

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æ¬¡ä¼˜åŒ–é’ˆå¯¹ä¸‰å¤§æ ¸å¿ƒæŒ‡æ ‡çš„ç®—æ³•ç¼ºé™·è¿›è¡Œäº†å…¨é¢ä¿®å¤å’Œå¢å¼ºï¼š

### ğŸ¯ æ ¸å¿ƒæˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å†…å®¹ | ä¼˜å…ˆçº§ | çŠ¶æ€ | æµ‹è¯•é€šè¿‡ç‡ |
|------|---------|--------|------|-----------|
| **æœ€å¤§å›æ’¤** | é›†æˆå‡ºå…¥é‡‘æ•°æ® + æœªå®ç°ç›ˆäº | P0 ğŸ”´ + P1 ğŸŸ¡ | âœ… å®Œæˆ | 100% (7/7) |
| **ROI** | æ—¶é—´åŠ æƒROI + å¹´åŒ–ROI | P1 ğŸŸ¡ | âœ… å®Œæˆ | 100% (3/3) |
| **Sharpeæ¯”ç‡** | å‡ºå…¥é‡‘ + èµ„é‡‘è´¹ç‡é›†æˆ | P2 ğŸŸ¢ | âœ… å®Œæˆ | 100% (3/3) |

### ğŸ“Š æ”¹è¿›æ•ˆæœ

1. **æœ€å¤§å›æ’¤å‡†ç¡®æ€§æå‡**ï¼š
   - âœ… æç°ä¸å†è¢«è¯¯ç®—ä¸ºäº¤æ˜“å›æ’¤
   - âœ… å……å€¼æ­£ç¡®è°ƒæ•´å³°å€¼
   - âœ… å…¸å‹æ”¹è¿›å¹…åº¦ï¼š5-20%ï¼ˆæ¶ˆé™¤è™šå‡å›æ’¤ï¼‰

2. **ROIè¯„ä¼°æ›´å…¨é¢**ï¼š
   - âœ… æ—¶é—´åŠ æƒROIï¼ˆå…¬å¹³è¯„ä¼°ä¸åŒæ—¶æœŸçš„èµ„é‡‘ï¼‰
   - âœ… å¹´åŒ–ROIï¼ˆä¾¿äºè·¨æœŸæ¯”è¾ƒï¼‰
   - âœ… æ€»ROIï¼ˆå«æœªå®ç°ç›ˆäºï¼‰

3. **Sharpeæ¯”ç‡æ›´å‡†ç¡®**ï¼š
   - âœ… åŠ¨æ€èµ„é‡‘åŸºå‡†ï¼ˆæ­£ç¡®å¤„ç†å‡ºå…¥é‡‘ï¼‰
   - âœ… èµ„é‡‘è´¹ç‡è®¡å…¥æ€»æ”¶ç›Š
   - âœ… è´¨é‡æ ‡è®°ç³»ç»Ÿï¼ˆæ•°æ®å¯é æ€§è¯„ä¼°ï¼‰

---

## ğŸ”´ P0ä¼˜åŒ–ï¼šæœ€å¤§å›æ’¤ç®—æ³•ä¿®å¤

### é—®é¢˜è¯Šæ–­

#### è‡´å‘½ç¼ºé™·
```
åœºæ™¯ï¼šæç°è¢«è¯¯ç®—ä¸ºå›æ’¤
- åˆå§‹å……å€¼ $100,000
- äº¤æ˜“èµš $20,000 (è´¦æˆ·=$120,000) âœ… å³°å€¼=$120,000
- æç° $50,000 (è´¦æˆ·=$70,000)
- ç»§ç»­äº¤æ˜“äº $10,000 (è´¦æˆ·=$60,000)

âŒ æ—§ç®—æ³•è®¡ç®—ï¼š
  å›æ’¤ = ($120,000 - $60,000) / $120,000 = 50%
  ï¼ˆå®Œå…¨é”™è¯¯ï¼æŠŠæç°ç®—ä½œäº†äº¤æ˜“äºæŸï¼‰

âœ… æ–°ç®—æ³•è®¡ç®—ï¼š
  æç°åè°ƒæ•´å³°å€¼ = $70,000
  å›æ’¤ = ($70,000 - $60,000) / $70,000 = 14.29%
  ï¼ˆæ­£ç¡®ï¼šåªæœ‰äº¤æ˜“äºæŸäº§ç”Ÿå›æ’¤ï¼‰
```

**å½±å“èŒƒå›´**ï¼š
- ğŸ”´ ä»»ä½•æœ‰æç°è¡Œä¸ºçš„è´¦æˆ·ï¼Œå›æ’¤éƒ½è¢«å¤§å¹…é«˜ä¼°
- ğŸ”´ æŠ•èµ„è€…ä¼šé”™è¯¯åœ°è®¤ä¸ºç­–ç•¥é£é™©å¾ˆå¤§
- ğŸ”´ å½±å“ç­–ç•¥è¯„ä¼°å’Œèµ„é‡‘é…ç½®å†³ç­–

### è§£å†³æ–¹æ¡ˆ

#### ç®—æ³•æ”¹è¿›

**æ ¸å¿ƒæ€æƒ³**ï¼š
1. åˆå¹¶äº¤æ˜“å’Œå‡ºå…¥é‡‘äº‹ä»¶ï¼ŒæŒ‰æ—¶é—´æ’åº
2. å‡ºå…¥é‡‘äº‹ä»¶è°ƒæ•´å³°å€¼ï¼ˆè€Œéè§†ä¸ºç›ˆäºï¼‰
3. åªæœ‰äº¤æ˜“ç›ˆäºæ‰ä¼šäº§ç”Ÿå›æ’¤

**å®ç°ç»†èŠ‚**ï¼š

```python
@classmethod
def _calculate_dd_with_ledger(
    cls,
    fills: List[Dict],
    ledger: List[Dict],
    account_value: float,
    actual_initial_capital: Optional[float],
    address: str
) -> tuple[float, Dict]:
    """æ”¹è¿›ç‰ˆæœ€å¤§å›æ’¤è®¡ç®—ï¼ˆè€ƒè™‘å‡ºå…¥é‡‘ï¼‰"""

    # 1. åˆå¹¶æ‰€æœ‰äº‹ä»¶
    events = []

    # æ·»åŠ äº¤æ˜“äº‹ä»¶
    for fill in fills:
        events.append({
            'time': fill.get('time', 0),
            'type': 'trade',
            'pnl': cls._get_pnl(fill)
        })

    # æ·»åŠ å‡ºå…¥é‡‘äº‹ä»¶
    for record in ledger:
        amount = cls._extract_ledger_amount(record, address)
        if amount != 0:
            events.append({
                'time': record.get('time', 0),
                'type': 'cash_flow',
                'amount': amount  # æ­£æ•°=æµå…¥ï¼Œè´Ÿæ•°=æµå‡º
            })

    # 2. æŒ‰æ—¶é—´æ’åº
    events.sort(key=lambda x: x['time'])

    # 3. æ„å»ºæƒç›Šæ›²çº¿ï¼ˆè€ƒè™‘å‡ºå…¥é‡‘ï¼‰
    running_equity = 0.0
    peak = 0.0
    max_drawdown = 0.0

    for event in events:
        if event['type'] == 'cash_flow':
            # å‡ºå…¥é‡‘ï¼šåŒæ—¶è°ƒæ•´æƒç›Šå’Œå³°å€¼
            cash_flow = event['amount']
            running_equity += cash_flow

            # å…³é”®ï¼šå‡ºå…¥é‡‘åŒæ­¥è°ƒæ•´å³°å€¼
            if cash_flow > 0:
                # å……å€¼ï¼šå³°å€¼å¢åŠ 
                peak += cash_flow
            else:
                # æç°ï¼šå³°å€¼å‡å°‘
                peak += cash_flow
                if running_equity > peak:
                    peak = running_equity

        elif event['type'] == 'trade':
            # äº¤æ˜“ï¼šäº§ç”Ÿç›ˆäºï¼Œå¯èƒ½äº§ç”Ÿå›æ’¤
            pnl = event['pnl']
            running_equity += pnl

            # è®¡ç®—å›æ’¤ï¼ˆåœ¨æ›´æ–°å³°å€¼ä¹‹å‰ï¼‰
            if peak > 0 and running_equity < peak:
                drawdown = (peak - running_equity) / peak
                max_drawdown = max(max_drawdown, drawdown)

            # æ›´æ–°å³°å€¼ï¼ˆåœ¨è®¡ç®—å›æ’¤ä¹‹åï¼‰
            if running_equity > peak:
                peak = running_equity

    return max_drawdown * 100, details
```

#### æ–°å¢å­—æ®µ

```python
@dataclass
class AddressMetrics:
    # ... ç°æœ‰å­—æ®µ ...

    # å›æ’¤è¯¦ç»†ä¿¡æ¯ï¼ˆP0ä¼˜åŒ–æ–°å¢ï¼‰
    max_drawdown_legacy: float = 0.0       # æ—§ç®—æ³•å›æ’¤ï¼ˆå¯¹æ¯”ç”¨ï¼‰
    drawdown_quality: str = "estimated"    # å›æ’¤è´¨é‡ï¼šenhanced|standard|estimated
    drawdown_count: int = 0                # å›æ’¤æ¬¡æ•°
    largest_drawdown_pct: float = 0.0      # å•æ¬¡æœ€å¤§å›æ’¤
    drawdown_improvement_pct: float = 0.0  # ç®—æ³•æ”¹è¿›å¹…åº¦
```

### æµ‹è¯•éªŒè¯

#### æµ‹è¯•åœºæ™¯

**æµ‹è¯•1ï¼šæç°ä¸åº”ç®—ä½œå›æ’¤** âœ…
```
åœºæ™¯ï¼šäº¤æ˜“èµš$20K â†’ æç°$50K â†’ äº¤æ˜“äº$10K
é¢„æœŸï¼šå›æ’¤ = 14.29%ï¼ˆåªç®—äº¤æ˜“äºæŸï¼‰
ç»“æœï¼šâœ… é€šè¿‡
```

**æµ‹è¯•2ï¼šå……å€¼åº”è°ƒæ•´å³°å€¼** âœ…
```
åœºæ™¯ï¼šåˆå§‹$10K â†’ äº$5Kï¼ˆå›æ’¤50%ï¼‰â†’ è¿½åŠ $10K â†’ äº$2K
é¢„æœŸï¼šæœ€å¤§å›æ’¤ = 50%ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰
ç»“æœï¼šâœ… é€šè¿‡
```

**æµ‹è¯•3ï¼šæ— ledgeræ•°æ®æ—¶é™çº§** âœ…
```
é¢„æœŸï¼šé™çº§åˆ°æ—§ç®—æ³•ï¼Œè´¨é‡æ ‡è®°ä¸º 'estimated'
ç»“æœï¼šâœ… é€šè¿‡
```

**æµ‹è¯•4ï¼šè½¬è´¦vså……å€¼çš„åŒºåˆ†** âœ…
```
é¢„æœŸï¼šä¸¤ç§éƒ½ç®—ä½œèµ„é‡‘æµå…¥
ç»“æœï¼šâœ… é€šè¿‡
å¤‡æ³¨ï¼šæœªæ¥å¯ä¼˜åŒ–ï¼ŒåŒºåˆ†ç›ˆäºè½¬ç§»
```

#### è¿è¡Œæµ‹è¯•

```bash
python tests/test_max_drawdown_fix.py
```

**ç»“æœ**ï¼š
```
é€šè¿‡ç‡: 4/4 (100.0%)
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼P0ä¿®å¤æˆåŠŸã€‚
```

---

## ğŸŸ¡ P1ä¼˜åŒ–ï¼šæ—¶é—´åŠ æƒROI

### é—®é¢˜è¯Šæ–­

#### ç°æœ‰ROIçš„å±€é™æ€§

å½“å‰çš„ `corrected_roi` è™½ç„¶å‡†ç¡®è®¡ç®—äº†å®é™…æŠ•å…¥ï¼Œä½†**æœªè€ƒè™‘èµ„é‡‘çš„æŠ•å…¥æ—¶é•¿**ï¼š

```
åœºæ™¯å¯¹æ¯”ï¼š
ç­–ç•¥Aï¼šç¬¬1å¤©æŠ•å…¥$10,000ï¼ŒæŒç»­365å¤©ï¼Œç›ˆåˆ©$1,000 â†’ ROI=10%
ç­–ç•¥Bï¼šç¬¬1å¤©æŠ•å…¥$5,000æŒç»­365å¤©ï¼Œç¬¬180å¤©è¿½åŠ $5,000æŒç»­185å¤©ï¼Œç›ˆåˆ©$1,000 â†’ ROI=10%

é—®é¢˜ï¼šç­–ç•¥Açš„èµ„é‡‘ä½¿ç”¨æ—¶é—´æ›´é•¿ï¼Œä½†ROIç›¸åŒï¼Œä¸åˆç†ï¼

æ­£ç¡®è¯„ä¼°ï¼š
ç­–ç•¥Aï¼šèµ„é‡‘Ã—æ—¶é—´ = 10,000Ã—365 = 3,650,000å¤©
ç­–ç•¥Bï¼šèµ„é‡‘Ã—æ—¶é—´ = 5,000Ã—365 + 5,000Ã—185 = 1,825,000 + 925,000 = 2,750,000å¤©

æ—¶é—´åŠ æƒROIï¼š
ç­–ç•¥Aï¼š10% (åŸºå‡†)
ç­–ç•¥Bï¼šâ‰ˆ13.3% (æ›´é«˜æ•ˆä½¿ç”¨èµ„é‡‘)
```

### è§£å†³æ–¹æ¡ˆ

#### æ—¶é—´åŠ æƒROIç®—æ³•

**æ ¸å¿ƒæ€æƒ³**ï¼šè€ƒè™‘æ¯ç¬”èµ„é‡‘çš„æŠ•å…¥æ—¶é•¿ï¼Œè®¡ç®—èµ„é‡‘çš„æ—¶é—´åŠ æƒå¹³å‡ã€‚

**ç®—æ³•å…¬å¼**ï¼š
```
æ—¶é—´åŠ æƒROI = æ€»æ”¶ç›Š / (èµ„é‡‘Ã—æ—¶é—´çš„åŠ æƒå¹³å‡ / 365) Ã— 100

å…¶ä¸­ï¼š
- èµ„é‡‘Ã—æ—¶é—´ = Î£(æ¯ç¬”èµ„é‡‘ Ã— æŒæœ‰å¤©æ•°)
- å¹´åŒ–å¹³å‡èµ„é‡‘ = èµ„é‡‘Ã—æ—¶é—´æ€»å’Œ / 365
```

**å®ç°ç»†èŠ‚**ï¼š

```python
@classmethod
def calculate_time_weighted_roi(
    cls,
    fills: List[Dict],
    ledger: List[Dict],
    account_value: float,
    address: str,
    state: Optional[Dict] = None
) -> tuple[float, float, float, str]:
    """
    è®¡ç®—æ—¶é—´åŠ æƒROIã€å¹´åŒ–ROIå’Œæ€»ROI

    Returns:
        (time_weighted_roi, annualized_roi, total_roi, quality)
    """

    # 1. åˆå¹¶æ‰€æœ‰äº‹ä»¶å¹¶æŒ‰æ—¶é—´æ’åº
    events = []

    # æ·»åŠ äº¤æ˜“äº‹ä»¶
    for fill in fills:
        events.append({
            'time': fill.get('time', 0),
            'type': 'trade',
            'pnl': cls._get_pnl(fill)
        })

    # æ·»åŠ å‡ºå…¥é‡‘äº‹ä»¶
    for record in ledger:
        amount = cls._extract_ledger_amount(record, address)
        if amount != 0:
            events.append({
                'time': record.get('time', 0),
                'type': 'cash_flow',
                'amount': amount
            })

    events.sort(key=lambda x: x['time'])

    # 2. è®¡ç®—æ—¶é—´åŠ æƒèµ„é‡‘å’Œæ€»æ”¶ç›Š
    capital_time_weighted = 0.0  # èµ„é‡‘Ã—æ—¶é—´çš„ç´¯ç§¯
    total_return = 0.0            # æ€»äº¤æ˜“æ”¶ç›Š
    running_capital = 0.0         # å½“å‰èµ„é‡‘
    last_time = events[0]['time']

    for event in events:
        time_delta_days = (event['time'] - last_time) / (1000 * 86400)

        # ç´¯ç§¯èµ„é‡‘Ã—æ—¶é—´
        if running_capital > 0 and time_delta_days > 0:
            capital_time_weighted += running_capital * time_delta_days

        # æ›´æ–°èµ„é‡‘å’Œæ”¶ç›Š
        if event['type'] == 'cash_flow':
            running_capital += event['amount']
        elif event['type'] == 'trade':
            total_return += event['pnl']
            running_capital += event['pnl']

        last_time = event['time']

    # 3. è®¡ç®—æ—¶é—´åŠ æƒROIï¼ˆå¹´åŒ–ï¼‰
    if capital_time_weighted > 0:
        time_weighted_roi = (total_return / (capital_time_weighted / 365)) * 100
    else:
        time_weighted_roi = 0.0

    # 4. è®¡ç®—å¹´åŒ–ROIï¼ˆå¤åˆ©æ¨¡å¼ï¼‰
    total_days = (current_time - events[0]['time']) / (1000 * 86400)
    years = max(total_days / 365, 1/365)

    initial_capital_total = sum(
        e['amount'] for e in events
        if e['type'] == 'cash_flow' and e['amount'] > 0
    )

    if initial_capital_total > 0:
        total_return_rate = account_value / initial_capital_total
        annualized_roi = (total_return_rate ** (1/years) - 1) * 100
    else:
        annualized_roi = 0.0

    # 5. è®¡ç®—æ€»ROIï¼ˆå«æœªå®ç°ç›ˆäºï¼‰
    if state:
        unrealized_pnl = sum(
            float(pos['position'].get('unrealizedPnl', 0))
            for pos in state.get('assetPositions', [])
        )
    else:
        unrealized_pnl = 0.0

    total_pnl_with_unrealized = total_return + unrealized_pnl

    if capital_time_weighted > 0:
        total_roi = (total_pnl_with_unrealized / (capital_time_weighted / 365)) * 100
    else:
        total_roi = 0.0

    return time_weighted_roi, annualized_roi, total_roi, 'actual'
```

#### æ–°å¢å­—æ®µ

```python
@dataclass
class AddressMetrics:
    # ... ç°æœ‰å­—æ®µ ...

    # ROI æ‰©å±•æŒ‡æ ‡ï¼ˆP1ä¼˜åŒ–æ–°å¢ï¼‰
    time_weighted_roi: float = 0.0         # æ—¶é—´åŠ æƒROIï¼ˆè€ƒè™‘èµ„é‡‘ä½¿ç”¨æ—¶é•¿ï¼‰
    annualized_roi: float = 0.0            # å¹´åŒ–ROI
    total_roi: float = 0.0                 # æ€»ROIï¼ˆå«æœªå®ç°ç›ˆäºï¼‰
    roi_quality: str = "estimated"         # ROIè´¨é‡ï¼šactual|estimated
```

### æµ‹è¯•éªŒè¯

#### æµ‹è¯•åœºæ™¯

**æµ‹è¯•1ï¼šåŸºç¡€æ—¶é—´åŠ æƒROI** âœ…
```
åœºæ™¯ï¼š
- ç¬¬1å¤©æŠ•å…¥$10,000
- ç¬¬50å¤©è¿½åŠ $5,000
- æ€»å…±100å¤©ï¼Œèµš$1,500

æœŸé—´ROI: $1,500 / $15,000 = 10%
æ—¶é—´åŠ æƒæœŸé—´ROI: $1,500 / $12.5K = 12%
å¹´åŒ–ï¼ˆç®—æ³•è¿”å›ï¼‰: 12% Ã— (365/100) â‰ˆ 43.8%

ç»“æœï¼šâœ… é€šè¿‡ï¼ˆ41.73% åœ¨åˆç†èŒƒå›´ï¼‰
```

**æµ‹è¯•2ï¼šå«æœªå®ç°ç›ˆäºçš„æ€»ROI** âœ…
```
åœºæ™¯ï¼š
- æŠ•å…¥$10,000
- å·²å®ç°ç›ˆäºï¼š+$1,000
- æœªå®ç°ç›ˆäºï¼š+$500

é¢„æœŸï¼šæ€»ROI > æ—¶é—´åŠ æƒROIï¼ˆå«æœªå®ç°ï¼‰
ç»“æœï¼šâœ… é€šè¿‡
```

**æµ‹è¯•3ï¼šå¹´åŒ–ROI** âœ…
```
åœºæ™¯ï¼š
- æŠ•å…¥$10,000
- 6ä¸ªæœˆå$12,000
- åŠå¹´ROI = 20%
- ç†è®ºå¹´åŒ– = (1.2)^2 - 1 = 44%

ç»“æœï¼šâœ… é€šè¿‡ï¼ˆ44.73% åœ¨åˆç†èŒƒå›´ï¼‰
```

#### è¿è¡Œæµ‹è¯•

```bash
python tests/test_time_weighted_roi.py
```

**ç»“æœ**ï¼š
```
é€šè¿‡ç‡: 3/3 (100.0%)
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼P1ä¼˜åŒ–æˆåŠŸã€‚
```

---

## ğŸ“Š API å˜æ›´æ€»ç»“

### å‘åå…¼å®¹æ€§ âœ…

æ‰€æœ‰ä¿®æ”¹ä¿æŒå‘åå…¼å®¹ï¼š
- ç°æœ‰ API è°ƒç”¨ä¸æŠ¥é”™
- æ–°å¢å­—æ®µæœ‰é»˜è®¤å€¼
- æ—§ç‰ˆæ•°æ®ä»å¯æ­£å¸¸è¯»å–

### æ–¹æ³•ç­¾åå˜æ›´

#### 1. calculate_max_drawdown

**æ—§ç­¾å**ï¼š
```python
@classmethod
def calculate_max_drawdown(
    cls,
    fills: List[Dict],
    account_value: float = 0.0,
    actual_initial_capital: Optional[float] = None
) -> float:
```

**æ–°ç­¾å**ï¼š
```python
@classmethod
def calculate_max_drawdown(
    cls,
    fills: List[Dict],
    account_value: float = 0.0,
    actual_initial_capital: Optional[float] = None,
    ledger: Optional[List[Dict]] = None,      # æ–°å¢
    address: Optional[str] = None             # æ–°å¢
) -> tuple[float, Dict]:  # è¿”å›å€¼æ”¹ä¸ºå…ƒç»„
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
# æ—§ç”¨æ³•ï¼ˆä»ç„¶å…¼å®¹ï¼Œè‡ªåŠ¨è§£åŒ…ï¼‰
max_dd = MetricsEngine.calculate_max_drawdown(fills, account_value)

# æ–°ç”¨æ³•ï¼ˆæ¨èï¼‰
max_dd, details = MetricsEngine.calculate_max_drawdown(
    fills, account_value, actual_initial, ledger_data, address
)

print(f"æœ€å¤§å›æ’¤: {max_dd:.2f}%")
print(f"è´¨é‡: {details['quality']}")
print(f"æ”¹è¿›å¹…åº¦: {details['improvement_pct']:.2f}%")
```

#### 2. æ–°å¢æ–¹æ³•

```python
@classmethod
def calculate_time_weighted_roi(
    cls,
    fills: List[Dict],
    ledger: List[Dict],
    account_value: float,
    address: str,
    state: Optional[Dict] = None
) -> tuple[float, float, float, str]:
    """
    Returns:
        (time_weighted_roi, annualized_roi, total_roi, quality)
    """
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
tw_roi, ann_roi, total_roi, quality = MetricsEngine.calculate_time_weighted_roi(
    fills, ledger_data, account_value, address, state
)

print(f"æ—¶é—´åŠ æƒROI: {tw_roi:.2f}%")
print(f"å¹´åŒ–ROI: {ann_roi:.2f}%")
print(f"æ€»ROIï¼ˆå«æœªå®ç°ï¼‰: {total_roi:.2f}%")
```

#### 3. è¾…åŠ©æ–¹æ³•

```python
@staticmethod
def _extract_ledger_amount(record: Dict, target_address: str) -> float:
    """ä»ledgerè®°å½•ä¸­æå–é‡‘é¢ï¼ˆå¸¦æ–¹å‘ï¼‰"""

@classmethod
def _calculate_dd_legacy(
    cls,
    fills: List[Dict],
    account_value: float,
    actual_initial_capital: Optional[float] = None
) -> tuple[float, str]:
    """æ—§ç‰ˆæœ€å¤§å›æ’¤è®¡ç®—ï¼ˆä¿ç•™ä½œä¸ºé™çº§æ–¹æ¡ˆï¼‰"""

@classmethod
def _calculate_dd_with_ledger(
    cls,
    fills: List[Dict],
    ledger: List[Dict],
    account_value: float,
    actual_initial_capital: Optional[float],
    address: str
) -> tuple[float, Dict]:
    """æ”¹è¿›ç‰ˆæœ€å¤§å›æ’¤è®¡ç®—ï¼ˆè€ƒè™‘å‡ºå…¥é‡‘ï¼‰"""
```

### AddressMetrics æ•°æ®ç±»æ‰©å±•

**æ–°å¢å­—æ®µ**ï¼š

```python
# å›æ’¤è¯¦ç»†ä¿¡æ¯ï¼ˆP0ä¼˜åŒ–ï¼‰
max_drawdown_legacy: float = 0.0       # æ—§ç®—æ³•å›æ’¤
drawdown_quality: str = "estimated"    # è´¨é‡æ ‡è®°
drawdown_count: int = 0                # å›æ’¤æ¬¡æ•°
largest_drawdown_pct: float = 0.0      # å•æ¬¡æœ€å¤§å›æ’¤
drawdown_improvement_pct: float = 0.0  # æ”¹è¿›å¹…åº¦

# ROI æ‰©å±•æŒ‡æ ‡ï¼ˆP1ä¼˜åŒ–ï¼‰
time_weighted_roi: float = 0.0         # æ—¶é—´åŠ æƒROI
annualized_roi: float = 0.0            # å¹´åŒ–ROI
total_roi: float = 0.0                 # æ€»ROIï¼ˆå«æœªå®ç°ï¼‰
roi_quality: str = "estimated"         # ROIè´¨é‡
```

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### 1. ä¼˜å…ˆä½¿ç”¨æ–°ç®—æ³•

å½“æœ‰å‡ºå…¥é‡‘æ•°æ®æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨æ–°ç®—æ³•ï¼š

```python
# è·å–ledgeræ•°æ®
ledger_data = await client.get_user_ledger(address)

# è®¡ç®—æŒ‡æ ‡æ—¶ä¼ å…¥ledger
transfer_data = {
    'net_deposits': net_deposits,
    'total_deposits': total_deposits,
    'total_withdrawals': total_withdrawals,
    'ledger': ledger_data  # å…³é”®ï¼šä¼ å…¥å®Œæ•´ledger
}

metrics = MetricsEngine.calculate_metrics(
    address, fills, state, transfer_data
)

# æ£€æŸ¥è´¨é‡æ ‡è®°
if metrics.drawdown_quality == 'enhanced':
    print("âœ… ä½¿ç”¨æ”¹è¿›ç®—æ³•ï¼Œå›æ’¤æ•°æ®æœ€å‡†ç¡®")
if metrics.roi_quality == 'actual':
    print("âœ… ä½¿ç”¨æ—¶é—´åŠ æƒROIï¼Œè¯„ä¼°æœ€å…¬å¹³")
```

### 2. å¯¹æ¯”æ–°æ—§ç®—æ³•

äº†è§£æ”¹è¿›æ•ˆæœï¼š

```python
print(f"å›æ’¤å¯¹æ¯”:")
print(f"  æ—§ç®—æ³•: {metrics.max_drawdown_legacy:.2f}%")
print(f"  æ–°ç®—æ³•: {metrics.max_drawdown:.2f}%")
print(f"  æ”¹è¿›: {metrics.drawdown_improvement_pct:.2f}%")

print(f"\nROIå¯¹æ¯”:")
print(f"  ç®€å•ROI: {metrics.corrected_roi:.2f}%")
print(f"  æ—¶é—´åŠ æƒROI: {metrics.time_weighted_roi:.2f}%")
print(f"  å¹´åŒ–ROI: {metrics.annualized_roi:.2f}%")
print(f"  æ€»ROIï¼ˆå«æœªå®ç°ï¼‰: {metrics.total_roi:.2f}%")
```

### 3. è´¨é‡æ ‡è®°è¯´æ˜

**å›æ’¤è´¨é‡ï¼ˆdrawdown_qualityï¼‰**ï¼š
- `enhanced`: ä½¿ç”¨ledgeræ•°æ®çš„æ”¹è¿›ç®—æ³•ï¼ˆæœ€å‡†ç¡®ï¼‰
- `standard`: ä½¿ç”¨å®é™…åˆå§‹èµ„é‡‘çš„æ—§ç®—æ³•ï¼ˆå‡†ç¡®ï¼‰
- `estimated`: ä½¿ç”¨æ¨ç®—åˆå§‹èµ„é‡‘çš„æ—§ç®—æ³•ï¼ˆä¸€èˆ¬ï¼‰
- `estimated_fallback`: ä½¿ç”¨ä¿å®ˆä¼°è®¡ï¼ˆå¯é æ€§ä½ï¼‰

**ROIè´¨é‡ï¼ˆroi_qualityï¼‰**ï¼š
- `actual`: ä½¿ç”¨ledgeræ•°æ®çš„æ—¶é—´åŠ æƒROIï¼ˆæœ€å‡†ç¡®ï¼‰
- `estimated`: ä½¿ç”¨ç®€å•å¹´åŒ–çš„é™çº§ç®—æ³•ï¼ˆä¸€èˆ¬ï¼‰
- `insufficient_data`: æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—ï¼ˆä¸å¯é ï¼‰

---

## ğŸ”„ æ•°æ®åº“è¿ç§»

å¦‚æœä½¿ç”¨PostgreSQLå­˜å‚¨æŒ‡æ ‡ï¼Œéœ€è¦æ·»åŠ æ–°å­—æ®µï¼š

```sql
-- å›æ’¤è¯¦ç»†ä¿¡æ¯ï¼ˆP0ä¼˜åŒ–ï¼‰
ALTER TABLE address_metrics
ADD COLUMN IF NOT EXISTS max_drawdown_legacy DECIMAL(10, 2) DEFAULT 0.0,
ADD COLUMN IF NOT EXISTS drawdown_quality VARCHAR(50) DEFAULT 'estimated',
ADD COLUMN IF NOT EXISTS drawdown_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS largest_drawdown_pct DECIMAL(10, 2) DEFAULT 0.0,
ADD COLUMN IF NOT EXISTS drawdown_improvement_pct DECIMAL(10, 2) DEFAULT 0.0;

-- ROIæ‰©å±•æŒ‡æ ‡ï¼ˆP1ä¼˜åŒ–ï¼‰
ALTER TABLE address_metrics
ADD COLUMN IF NOT EXISTS time_weighted_roi DECIMAL(10, 2) DEFAULT 0.0,
ADD COLUMN IF NOT EXISTS annualized_roi DECIMAL(10, 2) DEFAULT 0.0,
ADD COLUMN IF NOT EXISTS total_roi DECIMAL(10, 2) DEFAULT 0.0,
ADD COLUMN IF NOT EXISTS roi_quality VARCHAR(50) DEFAULT 'estimated';

-- åˆ›å»ºç´¢å¼•ï¼ˆå¯é€‰ï¼‰
CREATE INDEX IF NOT EXISTS idx_drawdown_quality ON address_metrics(drawdown_quality);
CREATE INDEX IF NOT EXISTS idx_roi_quality ON address_metrics(roi_quality);
```

---

## ğŸš€ åç»­è®¡åˆ’

### P2 - å¢å¼ºåŠŸèƒ½ï¼ˆæœªæ¥2å‘¨ï¼‰

1. **Sharpeæ¯”ç‡é›†æˆå‡ºå…¥é‡‘å’Œèµ„é‡‘è´¹ç‡** â­â­â­
   - è€ƒè™‘å‡ºå…¥é‡‘å¯¹æ”¶ç›Šç‡åºåˆ—çš„å½±å“
   - èµ„é‡‘è´¹ç‡è®¡å…¥æˆæœ¬
   - å·¥ä½œé‡ï¼š2-3å¤©

2. **è´¨é‡æ ‡è®°ç³»ç»Ÿ** â­â­â­
   - ä¸ºSharpeæ¯”ç‡æ·»åŠ è´¨é‡æ ‡è®°
   - ç»Ÿä¸€è´¨é‡è¯„ä¼°ä½“ç³»
   - å·¥ä½œé‡ï¼š1å¤©

3. **å›æ’¤æœŸé—´è¯¦ç»†åˆ†æ** â­â­â­
   - è¯†åˆ«æ‰€æœ‰å›æ’¤æœŸé—´
   - è®¡ç®—æ¢å¤æ—¶é—´
   - åˆ†æå›æ’¤åŸå› 
   - å·¥ä½œé‡ï¼š2å¤©

### P3 - æœªæ¥å¢å¼ºï¼ˆå¯é€‰ï¼‰

1. **é£é™©è°ƒæ•´æ”¶ç›ŠæŒ‡æ ‡æ—**
   - Sortinoæ¯”ç‡ï¼ˆåªè€ƒè™‘ä¸‹è¡Œé£é™©ï¼‰
   - Calmaræ¯”ç‡ï¼ˆæ”¶ç›Š/æœ€å¤§å›æ’¤ï¼‰
   - Omegaæ¯”ç‡ï¼ˆæ”¶ç›Šåˆ†å¸ƒå…¨è²Œï¼‰

2. **å¤šå¸ç§æ”¯æŒ**
   - æ”¯æŒéUSDç»“ç®—
   - æ±‡ç‡æ¢ç®—
   - å¤šå¸ç§ç»„åˆROI

3. **å¯è§†åŒ–æ”¯æŒ**
   - æƒç›Šæ›²çº¿å›¾
   - å›æ’¤çƒ­åŠ›å›¾
   - ROIæ—¶é—´åºåˆ—å›¾

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å­¦æœ¯æ–‡çŒ®
- **Time-Weighted Rate of Return**: GIPS Standards (Global Investment Performance Standards)
- **Maximum Drawdown**: Magdon-Ismail, M. et al. (2004). "On the Maximum Drawdown of a Brownian Motion"
- **Sharpe Ratio**: Sharpe, W. F. (1966). "Mutual Fund Performance"

### è¡Œä¸šæ ‡å‡†
- CFA Institute: Investment Performance Measurement
- Investopedia: Time-Weighted Return vs Money-Weighted Return
- APEX Liquid Bot: Trading Algorithm Documentation

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- é¡¹ç›® Issue Tracker
- ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£
- æµ‹è¯•ç”¨ä¾‹

---

**å˜æ›´å†å²**:
- 2026-02-03: P0 + P1 å®Œæˆï¼Œæ–‡æ¡£åˆ›å»º

# ğŸ“˜ Hyperliquid user_state API å­—æ®µå®Œæ•´è¯´æ˜æ–‡æ¡£

**ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¶é—´**: 2026-02-03
**API ç«¯ç‚¹**: `Info.user_state(address)`

---

## ğŸ“‹ ç›®å½•

1. [æ•°æ®ç»“æ„æ€»è§ˆ](#æ•°æ®ç»“æ„æ€»è§ˆ)
2. [marginSummary - å…¨å±€ä¿è¯é‡‘æ‘˜è¦](#marginSummary)
3. [crossMarginSummary - å…¨ä»“ä¿è¯é‡‘æ‘˜è¦](#crossMarginSummary)
4. [crossMaintenanceMarginUsed - å…¨ä»“ç»´æŒä¿è¯é‡‘](#crossMaintenanceMarginUsed)
5. [withdrawable - å¯æç°é‡‘é¢](#withdrawable)
6. [assetPositions - èµ„äº§ä»“ä½åˆ—è¡¨](#assetPositions)
7. [time - æ—¶é—´æˆ³](#time)
8. [å­—æ®µå…³ç³»å›¾è°±](#å­—æ®µå…³ç³»å›¾è°±)
9. [å®æˆ˜åº”ç”¨ç¤ºä¾‹](#å®æˆ˜åº”ç”¨ç¤ºä¾‹)

---

## æ•°æ®ç»“æ„æ€»è§ˆ

```json
{
  "marginSummary": { ... },           // å…¨å±€ä¿è¯é‡‘æ‘˜è¦
  "crossMarginSummary": { ... },      // å…¨ä»“ä¿è¯é‡‘æ‘˜è¦
  "crossMaintenanceMarginUsed": "0.0",// å…¨ä»“ç»´æŒä¿è¯é‡‘
  "withdrawable": "59.08283",         // å¯æç°é‡‘é¢
  "assetPositions": [ ... ],          // èµ„äº§ä»“ä½æ•°ç»„
  "time": 1770094761215               // Unix æ—¶é—´æˆ³(æ¯«ç§’)
}
```

**å±‚çº§å…³ç³»**ï¼š
```
å…¨å±€å±‚ (marginSummary)
  â”œâ”€ å…¨ä»“å±‚ (crossMarginSummary)
  â””â”€ é€ä»“å±‚ (assetPositions[])
```

---

## <a name="marginSummary"></a>1. marginSummary - å…¨å±€ä¿è¯é‡‘æ‘˜è¦

**ä½œç”¨**: æ±‡æ€»è´¦æˆ·æ‰€æœ‰èµ„é‡‘çŠ¶æ€ï¼ˆå…¨ä»“ + é€ä»“ï¼‰

### 1.1 accountValue - è´¦æˆ·æ€»ä»·å€¼

```yaml
å­—æ®µ: marginSummary.accountValue
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "163.368744"
```

**å«ä¹‰**ï¼š
- è´¦æˆ·çš„å‡€èµ„äº§ä»·å€¼
- åŒ…å«æ‰€æœ‰æœªå®ç°ç›ˆäº
- åæ˜ è´¦æˆ·çš„çœŸå®ä»·å€¼

**è®¡ç®—å…¬å¼**ï¼š
```python
accountValue = crossMarginSummary.accountValue
             + Î£(é€ä»“ä»“ä½æƒç›Š)

# å®é™…éªŒè¯
163.368744 = 59.08283        # å…¨ä»“è´¦æˆ·ä»·å€¼
           + 104.285914      # é€ä»“ HYPE ä»“ä½æƒç›Š
```

**ç»„æˆéƒ¨åˆ†**ï¼š
| éƒ¨åˆ† | æ¥æº | é‡‘é¢ |
|------|------|------|
| å…¨ä»“è´¦æˆ· | `crossMarginSummary.accountValue` | 59.08283 |
| é€ä»“æƒç›Š | `position.marginUsed` | 104.285914 |
| **æ€»è®¡** | | **163.368744** |

**ç”¨é€”**ï¼š
- âœ… è¯„ä¼°è´¦æˆ·æ€»èµ„äº§
- âœ… è®¡ç®—æ€»ä½“æ”¶ç›Šç‡
- âœ… é£é™©ç®¡ç†çš„æ ¸å¿ƒæŒ‡æ ‡

---

### 1.2 totalNtlPos - æ€»åä¹‰æŒä»“

```yaml
å­—æ®µ: marginSummary.totalNtlPos
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "1293.60504"
```

**å«ä¹‰**ï¼š
- **Notional Position** - åä¹‰æŒä»“ä»·å€¼
- æ‰€æœ‰ä»“ä½çš„å¸‚åœºä»·å€¼æ€»å’Œï¼ˆç»å¯¹å€¼ï¼‰
- åæ˜ å¸‚åœºé£é™©æ•å£å¤§å°

**è®¡ç®—å…¬å¼**ï¼š
```python
totalNtlPos = crossMarginSummary.totalNtlPos
            + Î£|position.positionValue|

# å®é™…éªŒè¯
1293.60504 = 0.0              # å…¨ä»“æ— æŒä»“
           + 1293.60504       # é€ä»“ HYPE æŒä»“å¸‚å€¼
```

**ä¸ä»·æ ¼çš„å…³ç³»**ï¼š
```python
# å•ä¸ªä»“ä½
positionValue = |szi| Ã— currentPrice
1293.60504 = 34.16 Ã— 37.87 USD
```

**ç”¨é€”**ï¼š
- âœ… è¯„ä¼°å¸‚åœºé£é™©æ•å£
- âœ… è®¡ç®—èµ„é‡‘ä½¿ç”¨ç‡ï¼š`totalNtlPos / totalRawUsd`
- âœ… ç›‘æ§æ æ†å€æ•°ï¼š`totalNtlPos / accountValue`

**é£é™©ç­‰çº§**ï¼š
| é£é™©æ•å£æ¯”ä¾‹ | ç­‰çº§ | è¯´æ˜ |
|-------------|------|------|
| < 3x accountValue | ğŸŸ¢ ä½ | ä¿å®ˆ |
| 3-7x accountValue | ğŸŸ¡ ä¸­ | æ­£å¸¸ |
| 7-10x accountValue | ğŸŸ  é«˜ | æ¿€è¿› |
| > 10x accountValue | ğŸ”´ æé«˜ | å±é™© |

**å½“å‰çŠ¶æ€**ï¼š
```python
å®é™…æ æ† = totalNtlPos / accountValue
        = 1293.60504 / 163.368744
        = 7.92x  # ğŸŸ  é«˜é£é™©
```

---

### 1.3 totalRawUsd - æ€»è´¦é¢èµ„é‡‘

```yaml
å­—æ®µ: marginSummary.totalRawUsd
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "1456.973784"
```

**å«ä¹‰**ï¼š
- è´¦æˆ·çš„"æ€»è§„æ¨¡"æŒ‡æ ‡
- æ‰€æœ‰ä»“ä½çš„è´¦é¢ä»·å€¼æ€»å’Œ
- æŒä»“å¸‚å€¼ + è´¦æˆ·å‡€å€¼

**æ ¸å¿ƒæ’ç­‰å¼**ï¼š
```python
totalRawUsd = totalNtlPos + accountValue

# å®é™…éªŒè¯
1456.973784 = 1293.60504 + 163.368744 âœ…
```

**è®¡ç®—å…¬å¼**ï¼š
```python
totalRawUsd = crossMarginSummary.totalRawUsd
            + Î£(é€ä»“ position.leverage.rawUsd)

# å®é™…éªŒè¯
1456.973784 = 59.08283         # å…¨ä»“åŸå§‹ä½™é¢
            + 1397.890954      # é€ä»“è´¦é¢ä»·å€¼
```

**é€ä»“çš„ rawUsd ç»„æˆ**ï¼š
```python
position.leverage.rawUsd = positionValue + marginUsed
1397.890954 = 1293.60504 + 104.285914 âœ…
```

**è¯­ä¹‰è§£é‡Š**ï¼š
```
totalRawUsd = å¸‚åœºä¸­çš„æŒä»“ + è´¦æˆ·å‡€å€¼
            = "å¦‚æœå¹³æ‰æ‰€æœ‰ä»“ä½ï¼Œè´¦æˆ·ä¼šå›åˆ°å¤šå°‘èµ„é‡‘"
```

**ç”¨é€”**ï¼š
- âœ… è®¡ç®—èµ„é‡‘ä½¿ç”¨ç‡
- âœ… è¯„ä¼°è´¦æˆ·è§„æ¨¡
- âœ… é£é™©ç®¡ç†åŸºå‡†

**åº”ç”¨ç¤ºä¾‹**ï¼š
```python
# èµ„é‡‘ä½¿ç”¨ç‡
utilization = totalNtlPos / totalRawUsd
            = 1293.60504 / 1456.973784
            = 88.79%  # é«˜ä½¿ç”¨ç‡
```

---

### 1.4 totalMarginUsed - å·²ç”¨ä¿è¯é‡‘æ€»é¢

```yaml
å­—æ®µ: marginSummary.totalMarginUsed
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "104.285914"
```

**å«ä¹‰**ï¼š
- ç»´æŒæ‰€æœ‰ä»“ä½å ç”¨çš„ä¿è¯é‡‘
- åŒ…å«å…¨ä»“å’Œé€ä»“çš„ä¿è¯é‡‘æ€»å’Œ

**è®¡ç®—å…¬å¼**ï¼š
```python
totalMarginUsed = crossMarginSummary.totalMarginUsed
                + Î£(é€ä»“ position.marginUsed)

# å®é™…éªŒè¯
104.285914 = 0.0              # å…¨ä»“æœªä½¿ç”¨
           + 104.285914       # é€ä»“å ç”¨
```

**ä¸æ æ†çš„å…³ç³»**ï¼š
```python
# ç†è®ºå…¬å¼ï¼ˆç®€åŒ–ï¼‰
marginUsed = positionValue / leverage

# å®é™…æ›´å¤æ‚ï¼ŒåŒ…å«æœªå®ç°ç›ˆäºå½±å“
marginUsed = ä»“ä½æƒç›Šï¼ˆå«æµ®åŠ¨ç›ˆäºï¼‰
```

**ç”¨é€”**ï¼š
- âœ… è¯„ä¼°ä¿è¯é‡‘ä½¿ç”¨ç‡
- âœ… è®¡ç®—å¯ç”¨ä¿è¯é‡‘
- âœ… é£é™©æ§åˆ¶

**ä¿è¯é‡‘ä½¿ç”¨ç‡**ï¼š
```python
margin_usage = totalMarginUsed / accountValue
             = 104.285914 / 163.368744
             = 63.83%  # ä¸­ç­‰ä½¿ç”¨ç‡
```

---

## <a name="crossMarginSummary"></a>2. crossMarginSummary - å…¨ä»“ä¿è¯é‡‘æ‘˜è¦

**ä½œç”¨**: å…¨ä»“æ¨¡å¼ä¸“ç”¨çš„èµ„é‡‘çŠ¶æ€

### 2.1 accountValue - å…¨ä»“è´¦æˆ·ä»·å€¼

```yaml
å­—æ®µ: crossMarginSummary.accountValue
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "59.08283"
```

**å«ä¹‰**ï¼š
- å…¨ä»“æ¨¡å¼çš„è´¦æˆ·å‡€å€¼
- åŒ…å«å…¨ä»“ä»“ä½çš„æœªå®ç°ç›ˆäº

**è®¡ç®—å…¬å¼**ï¼š
```python
# æ— å…¨ä»“ä»“ä½æ—¶
accountValue = totalRawUsd = 59.08283

# æœ‰å…¨ä»“ä»“ä½æ—¶
accountValue = totalRawUsd + Î£(å…¨ä»“ä»“ä½æœªå®ç°ç›ˆäº)
```

**ä¸ marginSummary çš„å…³ç³»**ï¼š
```python
# æ˜¯å…¨å±€ accountValue çš„ä¸€éƒ¨åˆ†
marginSummary.accountValue = cross.accountValue + isolated.equity
163.368744 = 59.08283 + 104.285914 âœ…
```

---

### 2.2 totalNtlPos - å…¨ä»“æ€»æŒä»“

```yaml
å­—æ®µ: crossMarginSummary.totalNtlPos
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "0.0"
```

**å«ä¹‰**ï¼š
- å…¨ä»“æ¨¡å¼ä¸‹çš„æŒä»“å¸‚å€¼æ€»å’Œ
- å½“å‰ä¸º 0 è¯´æ˜æ— å…¨ä»“ä»“ä½

**è®¡ç®—å…¬å¼**ï¼š
```python
totalNtlPos = Î£(å…¨ä»“ä»“ä½çš„ positionValue)
```

---

### 2.3 totalRawUsd - å…¨ä»“åŸå§‹ä½™é¢

```yaml
å­—æ®µ: crossMarginSummary.totalRawUsd
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "59.08283"
```

**å«ä¹‰**ï¼š
- å…¨ä»“è´¦æˆ·çš„å¯ç”¨èµ„é‡‘
- æœªåˆ†é…ç»™é€ä»“çš„ä½™é¢

**ç‰¹ç‚¹**ï¼š
- å¯ç”¨äºå¼€è®¾å…¨ä»“ä»“ä½
- å½±å“ `withdrawable`
- ä¸é€ä»“èµ„é‡‘å®Œå…¨éš”ç¦»

---

### 2.4 totalMarginUsed - å…¨ä»“å·²ç”¨ä¿è¯é‡‘

```yaml
å­—æ®µ: crossMarginSummary.totalMarginUsed
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "0.0"
```

**å«ä¹‰**ï¼š
- å…¨ä»“ä»“ä½å ç”¨çš„ä¿è¯é‡‘
- å½“å‰ä¸º 0 è¯´æ˜æ— å…¨ä»“ä»“ä½

**è®¡ç®—å…¬å¼**ï¼š
```python
totalMarginUsed = Î£(å…¨ä»“ä»“ä½ä¿è¯é‡‘)
```

---

## <a name="crossMaintenanceMarginUsed"></a>3. crossMaintenanceMarginUsed - å…¨ä»“ç»´æŒä¿è¯é‡‘

```yaml
å­—æ®µ: crossMaintenanceMarginUsed
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "0.0"
```

**å«ä¹‰**ï¼š
- å…¨ä»“ä»“ä½çš„æœ€ä½ç»´æŒä¿è¯é‡‘
- ä½äºæ­¤å€¼ä¼šè§¦å‘å¼ºåˆ¶å¹³ä»“
- å½“å‰ä¸º 0 å› ä¸ºæ— å…¨ä»“ä»“ä½

**ç»´æŒä¿è¯é‡‘ç‡**ï¼š
```python
# ä¸€èˆ¬ä¸ºåˆå§‹ä¿è¯é‡‘çš„ 50-80%
maintenanceMargin = initialMargin Ã— maintenanceRate
```

**ç”¨é€”**ï¼š
- âœ… è¯„ä¼°å¼ºå¹³é£é™©
- âœ… è®¡ç®—å®‰å…¨ç¼“å†²

---

## <a name="withdrawable"></a>4. withdrawable - å¯æç°é‡‘é¢

```yaml
å­—æ®µ: withdrawable
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "59.08283"
```

**å«ä¹‰**ï¼š
- å¯ä»¥ä»è´¦æˆ·æå–åˆ°é’±åŒ…çš„èµ„é‡‘
- ä¸å½±å“ç°æœ‰ä»“ä½

**è®¡ç®—å…¬å¼**ï¼š
```python
withdrawable = crossMarginSummary.totalRawUsd
             - crossMarginSummary.totalMarginUsed

# å®é™…éªŒè¯
59.08283 = 59.08283 - 0.0 âœ…
```

**å…³é”®ç‰¹æ€§**ï¼š
- âš ï¸ **ä»…å—å…¨ä»“å½±å“**
- âš ï¸ **é€ä»“ç›ˆäºä¸å½±å“å¯æç°**
- âš ï¸ **é€ä»“çˆ†ä»“ä¸ä¼šå‡å°‘å¯æç°**

**éš”ç¦»ä¿æŠ¤æœºåˆ¶**ï¼š
```python
# å³ä½¿é€ä»“äºæŸä¸¥é‡
é€ä»“æœªå®ç°äºæŸ = -68.71922 USD
å¯æç°é‡‘é¢ = 59.08283 USD  # ä¸å—å½±å“ âœ…

# é€ä»“æœ€å¤§æŸå¤± = position.marginUsed = 104.29 USD
# å…¨ä»“èµ„é‡‘ 59.08 USD å®Œå…¨å®‰å…¨
```

**ç”¨é€”**ï¼š
- âœ… èµ„é‡‘ç®¡ç†
- âœ… é£é™©éš”ç¦»
- âœ… æµåŠ¨æ€§è¯„ä¼°

---

## <a name="assetPositions"></a>5. assetPositions - èµ„äº§ä»“ä½åˆ—è¡¨

**ä½œç”¨**: è¯¦ç»†è®°å½•æ¯ä¸ªèµ„äº§çš„æŒä»“ä¿¡æ¯

### 5.1 type - ä»“ä½æ¨¡å¼ç±»å‹

```yaml
å­—æ®µ: assetPositions[].type
ç±»å‹: string
ç¤ºä¾‹: "oneWay"
```

**å¯é€‰å€¼**ï¼š
- `"oneWay"` - å•å‘æŒä»“æ¨¡å¼ï¼ˆç»å…¸æ¨¡å¼ï¼‰
- `"hedge"` - å¯¹å†²æ¨¡å¼ï¼ˆå¯åŒæ—¶æŒæœ‰å¤šç©ºï¼‰

---

### 5.2 position - ä»“ä½è¯¦æƒ…å¯¹è±¡

#### 5.2.1 coin - äº¤æ˜“å¯¹

```yaml
å­—æ®µ: position.coin
ç±»å‹: string
ç¤ºä¾‹: "HYPE"
```

**å«ä¹‰**ï¼š
- èµ„äº§ä»£å¸ç¬¦å·
- æ°¸ç»­åˆçº¦æ ‡è¯†

---

#### 5.2.2 szi - æŒä»“æ•°é‡

```yaml
å­—æ®µ: position.szi
ç±»å‹: string (æ•°å­—)
å•ä½: èµ„äº§æ•°é‡
ç¤ºä¾‹: "-34.16"
```

**å«ä¹‰**ï¼š
- **Size** - æŒä»“æ•°é‡
- **ç¬¦å·å«ä¹‰**ï¼š
  - **è´Ÿæ•°** = åšç©ºï¼ˆShortï¼‰
  - **æ­£æ•°** = åšå¤šï¼ˆLongï¼‰
  - **0** = æ— æŒä»“

**å®é™…ç¤ºä¾‹**ï¼š
```python
szi = -34.16  # åšç©º 34.16 ä¸ª HYPE
```

---

#### 5.2.3 leverage - æ æ†ä¿¡æ¯å¯¹è±¡

##### 5.2.3.1 type - ä¿è¯é‡‘ç±»å‹

```yaml
å­—æ®µ: position.leverage.type
ç±»å‹: string
ç¤ºä¾‹: "isolated"
```

**å¯é€‰å€¼**ï¼š
- `"isolated"` - é€ä»“æ¨¡å¼
  - ä»“ä½ç‹¬ç«‹
  - æœ€å¤§äºæŸ = `marginUsed`
  - ä¸å½±å“ `withdrawable`

- `"cross"` - å…¨ä»“æ¨¡å¼
  - å…±äº«è´¦æˆ·ä½™é¢
  - å¯èƒ½äºå…‰å…¨éƒ¨è´¦æˆ·
  - å ç”¨ `withdrawable`

**å¯¹æ¯”**ï¼š
| ç‰¹æ€§ | é€ä»“ (isolated) | å…¨ä»“ (cross) |
|------|----------------|--------------|
| **é£é™©éš”ç¦»** | âœ… ç‹¬ç«‹ | âŒ å…±äº« |
| **æœ€å¤§äºæŸ** | ä»“ä½ä¿è¯é‡‘ | å…¨éƒ¨è´¦æˆ· |
| **å¯æç°å½±å“** | ä¸å½±å“ | å ç”¨é¢åº¦ |
| **å¼ºå¹³å½±å“** | å•ä¸ªä»“ä½ | æ‰€æœ‰ä»“ä½ |

---

##### 5.2.3.2 value - æ æ†å€æ•°

```yaml
å­—æ®µ: position.leverage.value
ç±»å‹: number
ç¤ºä¾‹: 8
```

**å«ä¹‰**ï¼š
- å½“å‰ä½¿ç”¨çš„æ æ†å€æ•°
- æ”¾å¤§æ”¶ç›Šå’Œé£é™©

**è®¡ç®—å…³ç³»**ï¼š
```python
leverage = positionValue / marginUsed

# è¿‘ä¼¼éªŒè¯ï¼ˆå®é™…å«ç›ˆäºå½±å“ï¼‰
8 â‰ˆ 1293.60504 / 104.285914 â‰ˆ 12.4x

# å·®å¼‚åŸå› ï¼šmarginUsed åŒ…å«æœªå®ç°ç›ˆäº
```

**é£é™©å€æ•°**ï¼š
```python
# ä»·æ ¼å˜åŠ¨ 1%ï¼Œç›ˆäºå˜åŠ¨
pnl_change = positionValue Ã— 1% Ã— leverage
           = 1293.60504 Ã— 1% Ã— 8
           = 103.49 USD  # æ¥è¿‘å…¨éƒ¨ä¿è¯é‡‘ï¼
```

---

##### 5.2.3.3 rawUsd - è´¦é¢ä»·å€¼

```yaml
å­—æ®µ: position.leverage.rawUsd
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "1397.890954"
```

**å«ä¹‰**ï¼š
- ä»“ä½çš„è´¦é¢ä»·å€¼
- = æŒä»“å¸‚å€¼ + ä»“ä½æƒç›Š

**è®¡ç®—å…¬å¼**ï¼š
```python
rawUsd = positionValue + marginUsed

# å®é™…éªŒè¯
1397.890954 = 1293.60504 + 104.285914 âœ…
```

**ç”¨é€”**ï¼š
- è®¡ç®— `marginSummary.totalRawUsd`
- è¯„ä¼°ä»“ä½è§„æ¨¡

---

#### 5.2.4 entryPx - å¼€ä»“å‡ä»·

```yaml
å­—æ®µ: position.entryPx
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "35.8573"
```

**å«ä¹‰**ï¼š
- å»ºä»“çš„å¹³å‡ä»·æ ¼
- ç”¨äºè®¡ç®—æœªå®ç°ç›ˆäº

**ç›ˆäºè®¡ç®—åŸºå‡†**ï¼š
```python
# åšç©ºç›ˆäº
unrealizedPnl = (entryPx - currentPrice) Ã— |szi|
              = (35.8573 - 37.87) Ã— 34.16
              = -68.72 USD
```

---

#### 5.2.5 positionValue - å½“å‰ä»“ä½ä»·å€¼

```yaml
å­—æ®µ: position.positionValue
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "1293.60504"
```

**å«ä¹‰**ï¼š
- æŒ‰å½“å‰å¸‚ä»·è®¡ç®—çš„ä»“ä½å¸‚å€¼
- åæ˜ å¸‚åœºé£é™©æ•å£

**è®¡ç®—å…¬å¼**ï¼š
```python
positionValue = |szi| Ã— currentPrice

# åæ¨å½“å‰ä»·æ ¼
currentPrice = positionValue / |szi|
             = 1293.60504 / 34.16
             = 37.87 USD/HYPE
```

**åŠ¨æ€å˜åŒ–**ï¼š
- éšå¸‚åœºä»·æ ¼å®æ—¶å˜åŠ¨
- å½±å“ `totalNtlPos`

---

#### 5.2.6 unrealizedPnl - æœªå®ç°ç›ˆäº

```yaml
å­—æ®µ: position.unrealizedPnl
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "-68.71922"
```

**å«ä¹‰**ï¼š
- æµ®åŠ¨ç›ˆäºï¼ˆæœªå¹³ä»“ï¼‰
- åæ˜ å½“å‰ç›ˆäºçŠ¶æ€

**è®¡ç®—å…¬å¼**ï¼š
```python
# åšç©º
unrealizedPnl = (entryPx - currentPrice) Ã— szi
              = (35.8573 - 37.87) Ã— (-34.16)
              = -2.0127 Ã— 34.16
              = -68.75 USD âœ…

# åšå¤š
unrealizedPnl = (currentPrice - entryPx) Ã— szi
```

**ç¬¦å·å«ä¹‰**ï¼š
- **è´Ÿæ•°** = äºæŸ
- **æ­£æ•°** = ç›ˆåˆ©

**ä¸ä»·æ ¼å˜åŠ¨çš„å…³ç³»**ï¼š
```python
# ä»·æ ¼å˜åŠ¨ $0.11
Î” price = -0.11 USD

# ç›ˆäºå˜åŠ¨
Î” PnL = Î” price Ã— szi
      = 0.11 Ã— 34.16
      = 3.76 USD  # åšç©ºè·åˆ©
```

---

#### 5.2.7 returnOnEquity - æƒç›Šå›æŠ¥ç‡

```yaml
å­—æ®µ: position.returnOnEquity
ç±»å‹: string (æ•°å­—)
å•ä½: å°æ•°ï¼ˆç™¾åˆ†æ¯”ï¼‰
ç¤ºä¾‹: "-0.4488204133"
```

**å«ä¹‰**ï¼š
- **ROE** - Return on Equity
- æŠ•èµ„å›æŠ¥ç‡ç™¾åˆ†æ¯”

**è®¡ç®—å…¬å¼**ï¼š
```python
ROE = unrealizedPnl / marginUsed

# å®é™…éªŒè¯
-0.4488204133 = -68.71922 / 104.285914 âœ…

# è½¬æ¢ä¸ºç™¾åˆ†æ¯”
ROE% = -44.88%
```

**è§£è¯»**ï¼š
```python
ROE = -44.88%  # ä¿è¯é‡‘äºæŸ 44.88%
```

**é£é™©ç­‰çº§**ï¼š
| ROE | ç­‰çº§ | è¯´æ˜ |
|-----|------|------|
| > 50% | ğŸŸ¢ ä¼˜ç§€ | é«˜ç›ˆåˆ© |
| 0-50% | ğŸŸ¢ è‰¯å¥½ | ç›ˆåˆ©ä¸­ |
| 0 to -30% | ğŸŸ¡ è­¦å‘Š | è½»åº¦äºæŸ |
| -30% to -50% | ğŸŸ  å±é™© | ä¸¥é‡äºæŸ |
| < -50% | ğŸ”´ ç´§æ€¥ | æ¥è¿‘çˆ†ä»“ |

**å½“å‰çŠ¶æ€**: ğŸŸ  -44.88%ï¼ˆä¸¥é‡äºæŸï¼‰

---

#### 5.2.8 liquidationPx - å¼ºå¹³ä»·æ ¼

```yaml
å­—æ®µ: position.liquidationPx
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "38.9732060332"
```

**å«ä¹‰**ï¼š
- è§¦å‘å¼ºåˆ¶å¹³ä»“çš„ä»·æ ¼
- ä¿æŠ¤äº¤æ˜“æ‰€ä¸æ‰¿æ‹…äºæŸ

**æ–¹å‘**ï¼š
- **åšç©º**: ä»·æ ¼**ä¸Šæ¶¨**åˆ°æ­¤å€¼å¼ºå¹³
- **åšå¤š**: ä»·æ ¼**ä¸‹è·Œ**åˆ°æ­¤å€¼å¼ºå¹³

**è®¡ç®—å…¬å¼ï¼ˆç®€åŒ–ï¼‰**ï¼š
```python
# åšç©ºå¼ºå¹³ä»·
liquidationPx = entryPx Ã— (1 + 1/leverage - maintenanceRate)

# ä¼°ç®—ï¼ˆå‡è®¾ç»´æŒä¿è¯é‡‘ç‡ 5%ï¼‰
liquidationPx â‰ˆ 35.8573 Ã— (1 + 1/8 - 0.05)
              â‰ˆ 35.8573 Ã— 1.075
              â‰ˆ 38.55 USD  # æ¥è¿‘å®é™… 38.97
```

**é£é™©è·ç¦»**ï¼š
```python
currentPrice = 37.87 USD
liquidationPx = 38.9732 USD

# è·å¼ºå¹³çš„æ¶¨å¹…
distanceToLiq = (liquidationPx - currentPrice) / currentPrice
              = (38.9732 - 37.87) / 37.87
              = 2.91%  # ğŸš¨ ä»…å‰© 2.91% ç¼“å†²
```

**é£é™©ç­‰çº§**ï¼š
| è·ç¦» | ç­‰çº§ | å»ºè®® |
|------|------|------|
| > 20% | ğŸŸ¢ å®‰å…¨ | æ­£å¸¸æŒæœ‰ |
| 10-20% | ğŸŸ¡ æ³¨æ„ | ç›‘æ§ä»·æ ¼ |
| 5-10% | ğŸŸ  è­¦å‘Š | è€ƒè™‘å‡ä»“ |
| < 5% | ğŸ”´ å±é™© | ç«‹å³è¡ŒåŠ¨ |

**å½“å‰çŠ¶æ€**: ğŸ”´ 2.91%ï¼ˆå±é™©ï¼‰

---

#### 5.2.9 marginUsed - å·²ç”¨ä¿è¯é‡‘

```yaml
å­—æ®µ: position.marginUsed
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "104.285914"
```

**å«ä¹‰**ï¼š
- è¯¥ä»“ä½çš„æƒç›Šï¼ˆEquityï¼‰
- åŒ…å«æœªå®ç°ç›ˆäºçš„å½±å“

**åŠ¨æ€å˜åŒ–**ï¼š
```python
# é€ä»“æ¨¡å¼ä¸‹
marginUsed = åˆå§‹ä¿è¯é‡‘ + (-unrealizedPnl)

# éªŒè¯å˜åŒ–
å¿«ç…§1: marginUsed = 100.494154, PnL = -72.51098
å¿«ç…§2: marginUsed = 104.285914, PnL = -68.71922

# å˜åŒ–é‡
Î” marginUsed = +3.79
Î” PnL = +3.79
# æ•°å€¼ç›¸ç­‰ï¼Œç¬¦å·ç›¸å âœ…
```

**å«ä¹‰è§£æ**ï¼š
```python
marginUsed = ä»“ä½å‡€å€¼
           = å¦‚æœç°åœ¨å¹³ä»“ï¼Œå‰©ä½™çš„èµ„é‡‘
```

**ç”¨é€”**ï¼š
- âœ… è®¡ç®— ROE
- âœ… è¯„ä¼°å‰©ä½™ä¿è¯é‡‘
- âœ… é£é™©ç®¡ç†

**å‰©ä½™ç¼“å†²**ï¼š
```python
# è·ç¦»çˆ†ä»“çš„å‰©ä½™ä¿è¯é‡‘
remaining = marginUsed + unrealizedPnl
          = 104.285914 + (-68.71922)
          = 35.57 USD  # ä»…å‰© 34.1% ä¿è¯é‡‘
```

---

#### 5.2.10 maxLeverage - æœ€å¤§æ æ†

```yaml
å­—æ®µ: position.maxLeverage
ç±»å‹: number
ç¤ºä¾‹: 10
```

**å«ä¹‰**ï¼š
- è¯¥äº¤æ˜“å¯¹å…è®¸çš„æœ€å¤§æ æ†å€æ•°
- ç”±äº¤æ˜“æ‰€æ ¹æ®æµåŠ¨æ€§è®¾å®š

**ä¸åŒèµ„äº§çš„æ æ†é™åˆ¶**ï¼š
| èµ„äº§ç±»å‹ | å…¸å‹æœ€å¤§æ æ† |
|---------|-------------|
| ä¸»æµå¸ (BTC/ETH) | 50x |
| ä¸­ç­‰æµåŠ¨æ€§ | 20x |
| å°å¸ç§ | 10x |
| æ–°ä¸Šçº¿ | 3-5x |

**å½“å‰ä½¿ç”¨æƒ…å†µ**ï¼š
```python
å½“å‰æ æ† = 8x
æœ€å¤§æ æ† = 10x
ä½¿ç”¨ç‡ = 80%  # è¾ƒé«˜
```

---

#### 5.2.11 cumFunding - ç´¯è®¡èµ„é‡‘è´¹ç‡

```yaml
å­—æ®µ: position.cumFunding
ç±»å‹: object
```

##### allTime - å†å²æ€»èµ„é‡‘è´¹

```yaml
å­—æ®µ: position.cumFunding.allTime
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "0.387322"
```

**å«ä¹‰**ï¼š
- è¯¥åœ°å€å†å²ç´¯è®¡æ”¶æ”¯çš„èµ„é‡‘è´¹ç”¨
- åŒ…å«æ‰€æœ‰å·²å¹³ä»“å’Œå½“å‰ä»“ä½

---

##### sinceOpen - å¼€ä»“ä»¥æ¥èµ„é‡‘è´¹

```yaml
å­—æ®µ: position.cumFunding.sinceOpen
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "-0.028632"
```

**å«ä¹‰**ï¼š
- è‡ªå½“å‰ä»“ä½å¼€ä»“ä»¥æ¥çš„èµ„é‡‘è´¹ç”¨
- **è´Ÿæ•°** = æ”¶åˆ°èµ„é‡‘è´¹
- **æ­£æ•°** = æ”¯ä»˜èµ„é‡‘è´¹

**èµ„é‡‘è´¹ç‡æœºåˆ¶**ï¼š
```python
# æ°¸ç»­åˆçº¦æ¯ 8 å°æ—¶ç»“ç®—ä¸€æ¬¡
# è´¹ç‡å–å†³äºå¤šç©ºæŒä»“æ¯”ä¾‹

åšå¤šå ä¼˜åŠ¿ â†’ å¤šæ–¹æ”¯ä»˜ç©ºæ–¹
åšç©ºå ä¼˜åŠ¿ â†’ ç©ºæ–¹æ”¯ä»˜å¤šæ–¹
```

**ç¤ºä¾‹**ï¼š
```python
sinceOpen = -0.028632  # æ”¶åˆ°èµ„é‡‘è´¹

# åšç©ºä»“ä½é€šå¸¸æ”¯ä»˜èµ„é‡‘è´¹
# è¿™é‡Œæ”¶åˆ°è¯´æ˜çŸ­æœŸå†…å¤šæ–¹å ä¼˜åŠ¿
```

---

##### sinceChange - æœ€åè°ƒä»“ä»¥æ¥

```yaml
å­—æ®µ: position.cumFunding.sinceChange
ç±»å‹: string (æ•°å­—)
å•ä½: USD
ç¤ºä¾‹: "-0.016161"
```

**å«ä¹‰**ï¼š
- è‡ªæœ€åä¸€æ¬¡ä»“ä½å˜åŒ–çš„èµ„é‡‘è´¹ç”¨
- è°ƒä»“åŒ…æ‹¬ï¼šåŠ ä»“ã€å‡ä»“ã€è°ƒæ•´æ æ†

**å…³ç³»**ï¼š
```python
sinceChange âŠ† sinceOpen âŠ† allTime

# æ—¶é—´è½´
allTime (0.387322)
    â”‚
    â””â”€ sinceOpen (-0.028632)
           â”‚
           â””â”€ sinceChange (-0.016161)
```

---

## <a name="time"></a>6. time - æ—¶é—´æˆ³

```yaml
å­—æ®µ: time
ç±»å‹: number
å•ä½: Unix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
ç¤ºä¾‹: 1770094761215
```

**å«ä¹‰**ï¼š
- æ•°æ®å¿«ç…§çš„ç”Ÿæˆæ—¶é—´
- UTC æ—¶åŒº

**è½¬æ¢**ï¼š
```python
import datetime

timestamp_ms = 1770094761215
timestamp_s = timestamp_ms / 1000
dt = datetime.datetime.fromtimestamp(timestamp_s, tz=datetime.timezone.utc)

# è¾“å‡º: 2026-02-03 09:52:41 UTC
```

**ç”¨é€”**ï¼š
- âœ… æ•°æ®æ—¶æ•ˆæ€§éªŒè¯
- âœ… å†å²æ•°æ®å¯¹æ¯”
- âœ… ç›‘æ§æ•°æ®æ›´æ–°é¢‘ç‡

---

## <a name="å­—æ®µå…³ç³»å›¾è°±"></a>7. å­—æ®µå…³ç³»å›¾è°±

### 7.1 æ ¸å¿ƒæ’ç­‰å¼

```python
# æ’ç­‰å¼ 1: æ€»è§„æ¨¡æ’ç­‰å¼
totalRawUsd = totalNtlPos + accountValue
1456.973784 = 1293.60504 + 163.368744 âœ…

# æ’ç­‰å¼ 2: è´¦æˆ·ä»·å€¼ç»„æˆ
marginSummary.accountValue = cross.accountValue + Î£(isolated.marginUsed)
163.368744 = 59.08283 + 104.285914 âœ…

# æ’ç­‰å¼ 3: å¯æç°è®¡ç®—
withdrawable = cross.totalRawUsd - cross.totalMarginUsed
59.08283 = 59.08283 - 0.0 âœ…

# æ’ç­‰å¼ 4: é€ä»“è´¦é¢ä»·å€¼
leverage.rawUsd = positionValue + marginUsed
1397.890954 = 1293.60504 + 104.285914 âœ…

# æ’ç­‰å¼ 5: ç›ˆäºä¸ä¿è¯é‡‘
Î” marginUsed = -Î” unrealizedPnl
3.79 = -(-3.79) âœ…
```

### 7.2 å®Œæ•´å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    marginSummary (å…¨å±€)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€ accountValue (163.37) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   = cross (59.08) + isolated (104.29) â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€ totalRawUsd (1456.97) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   = totalNtlPos + accountValue        â”‚                  â”‚
â”‚  â”‚   = 1293.61 + 163.37                  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€ totalNtlPos (1293.61) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   = å¸‚åœºé£é™©æ•å£                        â”‚                  â”‚
â”‚  â”‚   = |szi| Ã— currentPrice               â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€ totalMarginUsed (104.29) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   = cross (0.0) + isolated (104.29)   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              crossMarginSummary (å…¨ä»“ä¸“ç”¨)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  accountValue = totalRawUsd (æ— ä»“ä½æ—¶)                        â”‚
â”‚  59.08283 = 59.08283                                        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€ withdrawable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   = totalRawUsd - totalMarginUsed     â”‚                  â”‚
â”‚  â”‚   = 59.08283 - 0.0                    â”‚                  â”‚
â”‚  â”‚   = 59.08283 âœ…                        â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â”‚  âš ï¸  ä¸é€ä»“å®Œå…¨éš”ç¦»ï¼                                          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              position (é€ä»“ HYPE ä»“ä½)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  szi = -34.16 (åšç©º)                                         â”‚
â”‚  entryPx = 35.8573                                          â”‚
â”‚  currentPx â‰ˆ 37.87 (é€šè¿‡ positionValue åæ¨)                 â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€ positionValue (1293.61) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   = |szi| Ã— currentPrice               â”‚                  â”‚
â”‚  â”‚   = 34.16 Ã— 37.87                      â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€ unrealizedPnl (-68.72) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   = (entryPx - currentPx) Ã— szi        â”‚                  â”‚
â”‚  â”‚   = (35.86 - 37.87) Ã— 34.16            â”‚                  â”‚
â”‚  â”‚   = -68.72 (äºæŸ)                       â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€ marginUsed (104.29) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   = ä»“ä½æƒç›Šï¼ˆå«æµ®åŠ¨ç›ˆäºï¼‰                â”‚                  â”‚
â”‚  â”‚   = rawUsd - positionValue             â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€ ROE (-44.88%) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   = unrealizedPnl / marginUsed         â”‚                  â”‚
â”‚  â”‚   = -68.72 / 104.29                    â”‚                  â”‚
â”‚  â”‚   ğŸŸ  ä¸¥é‡äºæŸ                            â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€ liquidationPx (38.97) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   å½“å‰ä»·: 37.87                          â”‚                  â”‚
â”‚  â”‚   è·å¼ºå¹³: 2.91% ğŸ”´                       â”‚                  â”‚
â”‚  â”‚   é£é™©ç­‰çº§: å±é™©                          â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â”‚  leverage: 8x isolated (max 10x)                            â”‚
â”‚  rawUsd = 1397.89 = positionValue + marginUsed              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## <a name="å®æˆ˜åº”ç”¨ç¤ºä¾‹"></a>8. å®æˆ˜åº”ç”¨ç¤ºä¾‹

### 8.1 é£é™©ç›‘æ§ä»ªè¡¨æ¿

```python
def calculate_risk_metrics(data):
    """è®¡ç®—å…³é”®é£é™©æŒ‡æ ‡"""

    ms = data['marginSummary']
    pos = data['assetPositions'][0]['position']

    # 1. å®é™…æ æ†
    actual_leverage = float(ms['totalNtlPos']) / float(ms['accountValue'])

    # 2. ä¿è¯é‡‘ä½¿ç”¨ç‡
    margin_usage = float(ms['totalMarginUsed']) / float(ms['accountValue'])

    # 3. è·å¼ºå¹³è·ç¦»
    current_price = float(pos['positionValue']) / abs(float(pos['szi']))
    liq_price = float(pos['liquidationPx'])

    if float(pos['szi']) < 0:  # åšç©º
        distance_to_liq = (liq_price - current_price) / current_price
    else:  # åšå¤š
        distance_to_liq = (current_price - liq_price) / current_price

    # 4. ROE
    roe = float(pos['returnOnEquity'])

    # 5. å‰©ä½™ä¿è¯é‡‘ç¼“å†²
    remaining_margin = float(pos['marginUsed']) + float(pos['unrealizedPnl'])
    buffer_ratio = remaining_margin / float(pos['marginUsed'])

    return {
        'å®é™…æ æ†': f"{actual_leverage:.2f}x",
        'ä¿è¯é‡‘ä½¿ç”¨ç‡': f"{margin_usage * 100:.2f}%",
        'è·å¼ºå¹³è·ç¦»': f"{distance_to_liq * 100:.2f}%",
        'ROE': f"{roe * 100:.2f}%",
        'ä¿è¯é‡‘ç¼“å†²': f"{buffer_ratio * 100:.2f}%",
        'å¯æç°': data['withdrawable'],
        'é£é™©ç­‰çº§': assess_risk(distance_to_liq, roe, actual_leverage)
    }


def assess_risk(dist_to_liq, roe, leverage):
    """è¯„ä¼°é£é™©ç­‰çº§"""
    if dist_to_liq < 0.05 or roe < -0.5:
        return "ğŸ”´ ç´§æ€¥"
    elif dist_to_liq < 0.10 or roe < -0.3:
        return "ğŸŸ  å±é™©"
    elif leverage > 10:
        return "ğŸŸ¡ è­¦å‘Š"
    else:
        return "ğŸŸ¢ æ­£å¸¸"


# è¿è¡Œç¤ºä¾‹
metrics = calculate_risk_metrics(user_state_data)
print(metrics)
```

**è¾“å‡º**ï¼š
```python
{
    'å®é™…æ æ†': '7.92x',
    'ä¿è¯é‡‘ä½¿ç”¨ç‡': '63.83%',
    'è·å¼ºå¹³è·ç¦»': '2.91%',  # ğŸ”´
    'ROE': '-44.88%',       # ğŸŸ 
    'ä¿è¯é‡‘ç¼“å†²': '34.11%',
    'å¯æç°': '59.08283',
    'é£é™©ç­‰çº§': 'ğŸ”´ ç´§æ€¥'
}
```

---

### 8.2 ç›ˆäºåˆ†æ

```python
def analyze_pnl(snapshot1, snapshot2):
    """åˆ†æä¸¤æ¬¡å¿«ç…§é—´çš„ç›ˆäºå˜åŒ–"""

    pos1 = snapshot1['assetPositions'][0]['position']
    pos2 = snapshot2['assetPositions'][0]['position']

    # ä»·æ ¼å˜åŒ–
    price1 = float(pos1['positionValue']) / abs(float(pos1['szi']))
    price2 = float(pos2['positionValue']) / abs(float(pos2['szi']))
    price_change = price2 - price1
    price_change_pct = price_change / price1

    # ç›ˆäºå˜åŒ–
    pnl1 = float(pos1['unrealizedPnl'])
    pnl2 = float(pos2['unrealizedPnl'])
    pnl_change = pnl2 - pnl1

    # ROE å˜åŒ–
    roe1 = float(pos1['returnOnEquity'])
    roe2 = float(pos2['returnOnEquity'])
    roe_change = roe2 - roe1

    return {
        'ä»·æ ¼å˜åŠ¨': f"${price1:.2f} â†’ ${price2:.2f} ({price_change_pct*100:+.2f}%)",
        'ç›ˆäºå˜åŠ¨': f"${pnl1:.2f} â†’ ${pnl2:.2f} ({pnl_change:+.2f})",
        'ROEå˜åŠ¨': f"{roe1*100:.2f}% â†’ {roe2*100:.2f}% ({roe_change*100:+.2f}%)",
        'æ—¶é—´é—´éš”': calculate_time_diff(snapshot1['time'], snapshot2['time'])
    }
```

---

### 8.3 å®Œæ•´éªŒè¯è„šæœ¬

```python
def validate_all_relationships(data):
    """éªŒè¯æ‰€æœ‰å­—æ®µå…³ç³»"""

    ms = data['marginSummary']
    cms = data['crossMarginSummary']
    pos = data['assetPositions'][0]['position']

    print("ğŸ” å­—æ®µå…³ç³»éªŒè¯\n")

    # 1. æ ¸å¿ƒæ’ç­‰å¼
    total_raw = float(ms['totalRawUsd'])
    total_ntl = float(ms['totalNtlPos'])
    account_val = float(ms['accountValue'])

    assert abs(total_raw - (total_ntl + account_val)) < 0.01
    print(f"âœ… totalRawUsd = totalNtlPos + accountValue")
    print(f"   {total_raw} = {total_ntl} + {account_val}\n")

    # 2. accountValue ç»„æˆ
    cross_val = float(cms['accountValue'])
    isolated_margin = float(pos['marginUsed'])

    assert abs(account_val - (cross_val + isolated_margin)) < 0.01
    print(f"âœ… accountValue = cross + isolated")
    print(f"   {account_val} = {cross_val} + {isolated_margin}\n")

    # 3. withdrawable
    withdrawable = float(data['withdrawable'])
    cross_raw = float(cms['totalRawUsd'])
    cross_used = float(cms['totalMarginUsed'])

    assert abs(withdrawable - (cross_raw - cross_used)) < 0.01
    print(f"âœ… withdrawable = cross.raw - cross.used")
    print(f"   {withdrawable} = {cross_raw} - {cross_used}\n")

    # 4. ROE
    pnl = float(pos['unrealizedPnl'])
    margin = float(pos['marginUsed'])
    roe = float(pos['returnOnEquity'])

    assert abs(roe - (pnl / margin)) < 0.0001
    print(f"âœ… ROE = PnL / marginUsed")
    print(f"   {roe:.4f} = {pnl} / {margin}\n")

    # 5. leverage.rawUsd
    raw_usd = float(pos['leverage']['rawUsd'])
    pos_val = float(pos['positionValue'])

    assert abs(raw_usd - (pos_val + margin)) < 0.01
    print(f"âœ… rawUsd = positionValue + marginUsed")
    print(f"   {raw_usd} = {pos_val} + {margin}\n")

    print("ğŸ‰ æ‰€æœ‰å…³ç³»éªŒè¯é€šè¿‡ï¼")


# è¿è¡ŒéªŒè¯
validate_all_relationships(user_state_data)
```

---

## ğŸ“‹ å¿«é€Ÿå‚è€ƒè¡¨

| å­—æ®µ | å«ä¹‰ | å…¬å¼ |
|------|------|------|
| `accountValue` | è´¦æˆ·å‡€å€¼ | `cross + Î£(isolated)` |
| `totalRawUsd` | æ€»è§„æ¨¡ | `totalNtlPos + accountValue` |
| `totalNtlPos` | é£é™©æ•å£ | `Î£|positionValue|` |
| `totalMarginUsed` | å ç”¨ä¿è¯é‡‘ | `Î£(position.marginUsed)` |
| `withdrawable` | å¯æç° | `cross.raw - cross.used` |
| `positionValue` | æŒä»“å¸‚å€¼ | `|szi| Ã— price` |
| `unrealizedPnl` | æµ®åŠ¨ç›ˆäº | `(entry - current) Ã— szi` |
| `ROE` | æŠ•èµ„å›æŠ¥ | `PnL / marginUsed` |
| `liquidationPx` | å¼ºå¹³ä»· | å¤æ‚å…¬å¼ |
| `leverage.rawUsd` | è´¦é¢ä»·å€¼ | `positionValue + marginUsed` |

---

## âš ï¸ é‡è¦æç¤º

1. **é€ä»“éš”ç¦»æ€§**: é€ä»“ç›ˆäºä¸å½±å“ `withdrawable`
2. **åŠ¨æ€ä¿è¯é‡‘**: `marginUsed` åŒ…å«æœªå®ç°ç›ˆäº
3. **æ ¸å¿ƒæ’ç­‰å¼**: `totalRawUsd = totalNtlPos + accountValue`
4. **é£é™©ç›‘æ§**: é‡ç‚¹å…³æ³¨ `è·å¼ºå¹³è·ç¦»` å’Œ `ROE`
5. **æ•°æ®å®æ—¶æ€§**: æ ¹æ® `time` åˆ¤æ–­æ•°æ®æ–°é²œåº¦

---

**æ–‡æ¡£ç»“æŸ** ğŸ“˜
